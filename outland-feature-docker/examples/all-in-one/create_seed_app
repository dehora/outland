#!/usr/bin/env bash

# these are also set in the .env file given to the server on startup
service="testconsole/service"
api_key="letmein"

ikey_app="idemkey-test-acme-namespace"

curl -i http://localhost:8180/namespaces \
-u ${service}:${api_key} \
-H "Content-type: application/json" \
-H "Idempotency-Key: ${ikey_app}" \
-d'
{
	"key": "test-acme-namespace",
	"name": "My Namespace",
	"owners": {
	  "items":[{
		  "name": "Acme",
		  "username": "acme",
		  "email": "acme@example.org"
		  }
		]
	},
	"granted": {
		"services": [{
			"key": "testservice",
			"name": "Test Service"
		}],
		"members": [{
			"username": "testuser",
			"name": "Test User"
		}]
	}
}
'

echo "Namespace created, adding some feature flags"

ikey_f1="idemkey-test-acme-namespace-f1"

curl -i http://localhost:8180/features \
-u ${service}:${api_key} \
-H "Content-type: application/json" \
-H "Idempotency-Key: ${ikey_f1}" \
-d '
{
	"key": "test-flag-1",
	"description": "A feature flag",
	"namespace": "test-acme-namespace",
	"owner": {
		"username": "acme",
		"email": "acme@example.org"
	}
}
'

ikey_f2="idemkey-test-acme-namespace-f2"

curl -i http://localhost:8180/features \
-u ${service}:${api_key} \
-H "Content-type: application/json" \
-H "Idempotency-Key: ${ikey_f2}" \
-d'
{
	"key": "test-option-1",
	"description": "A weighted feature",
	"namespace": "test-acme-namespace",
	"options": {
	  "option": "bool",
	  "items": [{
		"name": "false",
		"value": "false",
		"weight": 9000
    }, {
      "name": "true",
      "value": "true",
      "weight": 1000
    }]
	},
	"owner": {
		"username": "acme",
		"email": "acme@example.org"
	}
}
'